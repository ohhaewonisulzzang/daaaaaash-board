'use client'

import { useState, useEffect, useRef } from 'react'
import { useRouter } from 'next/navigation'
import { 
  DndContext, 
  DragEndEvent, 
  DragOverlay, 
  DragStartEvent,
  closestCenter,
  PointerSensor,
  useSensor,
  useSensors
} from '@dnd-kit/core'
import { SortableContext, rectSortingStrategy } from '@dnd-kit/sortable'
import { Button } from '@/lib/components/ui/button'
import { Navbar } from '@/lib/components/ui/navbar'
import { Badge } from '@/lib/components/ui/badge'
import { LoginModal } from '@/lib/components/ui/login-modal'
import { useAuth } from '@/lib/hooks'
import { useToast } from '@/lib/hooks/use-toast'
import UserNameEditor from '@/lib/components/profile/UserNameEditor'
import { ThemeToggle } from '@/lib/components/ui/theme-toggle'
import ResizableWidget from '@/lib/components/widgets/ResizableWidget'
import SortableWidget from '@/lib/components/widgets/SortableWidget'
import { 
  Plus, Edit, Save, Settings, Grid, LogOut
} from 'lucide-react'
import { 
  IWidget, 
  IWidgetSettings,
  ILinkSettings,
  IChecklistSettings,
  IWeatherSettings,
  IMemoSettings,
  ISearchSettings,
  ICalendarSettings,
  IBackgroundOption
} from '@/types'
import { normalizeUrl, extractDomain, getRecommendedIcon } from '@/lib/utils/urlUtils'
import { guestStorage } from '@/lib/utils/guestStorage'
import { useDashboard, useWidgetOperations } from './hooks'
import { AddWidgetModal, SettingsModal, WidgetRenderer, Sidebar } from './components'

export default function DashboardPage() {
  const { user, logout, isAuthenticated, isLoading, isGuestMode, exitGuestMode } = useAuth()
  const router = useRouter()
  const { toast } = useToast()
  const hasRedirectedRef = useRef(false)

  // ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ ÌõÖ
  const {
    dashboard,
    setDashboard,
    widgets,
    setWidgets,
    isDashboardLoading,
    loadDashboard
  } = useDashboard()

  // ÏúÑÏ†Ø ÏûëÏóÖ Í¥ÄÎ¶¨ ÌõÖ
  const {
    newWidgetData,
    setNewWidgetData,
    faviconLoading,
    setFaviconLoading,
    faviconError,
    setFaviconError,
    saveWidgetPositions,
    handleWidgetResize,
    removeWidget,
    updateChecklistItem,
    updateWidgetSettings,
    updateDashboardBackground,
    handleLayoutReset
  } = useWidgetOperations(widgets, setWidgets, dashboard, setDashboard)
  
  // UI ÏÉÅÌÉú Í¥ÄÎ¶¨
  const [isEditMode, setIsEditMode] = useState(false)
  const [isSidebarOpen, setIsSidebarOpen] = useState(false)
  const [isAddWidgetModalOpen, setIsAddWidgetModalOpen] = useState(false)
  const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false)
  const [isLoginModalOpen, setIsLoginModalOpen] = useState(false)
  const [selectedWidgetType, setSelectedWidgetType] = useState<string>('')
  const [userName, setUserName] = useState<string>('')
  const [activeId, setActiveId] = useState<string | null>(null)
  
  // ÏãúÍ≥Ñ ÏúÑÏ†ØÏö© ÌòÑÏû¨ ÏãúÍ∞Ñ ÏÉÅÌÉú
  const [currentTime, setCurrentTime] = useState(new Date())

  // Î∞∞Í≤Ω ÏòµÏÖò
  const backgroundOptions: IBackgroundOption[] = [
    { type: 'gradient', value: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', name: 'Î≥¥Îùº Í∑∏ÎùºÎç∞Ïù¥ÏÖò' },
    { type: 'gradient', value: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', name: 'ÌïëÌÅ¨ Í∑∏ÎùºÎç∞Ïù¥ÏÖò' },
    { type: 'gradient', value: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', name: 'ÌååÎûÄ Í∑∏ÎùºÎç∞Ïù¥ÏÖò' },
    { type: 'gradient', value: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', name: 'ÎÖπÏÉâ Í∑∏ÎùºÎç∞Ïù¥ÏÖò' },
    { type: 'gradient', value: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)', name: 'Î°úÏ¶à Í∑∏ÎùºÎç∞Ïù¥ÏÖò' },
    { type: 'gradient', value: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)', name: 'ÎØºÌä∏ Í∑∏ÎùºÎç∞Ïù¥ÏÖò' },
    { type: 'gradient', value: 'linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%)', name: 'ÎùºÎ≤§Îçî Í∑∏ÎùºÎç∞Ïù¥ÏÖò' },
    { type: 'gradient', value: 'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)', name: 'Ïä§Ïπ¥Ïù¥ Í∑∏ÎùºÎç∞Ïù¥ÏÖò' },
    { type: 'gradient', value: 'linear-gradient(135deg, #fdbb2d 0%, #22c1c3 100%)', name: 'ÏÑ†ÏÖã Í∑∏ÎùºÎç∞Ïù¥ÏÖò' },
    { type: 'gradient', value: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', name: 'ÎÑ§Ïò® Í∑∏ÎùºÎç∞Ïù¥ÏÖò' },
    { type: 'color', value: '#f8fafc', name: 'ÎùºÏù¥Ìä∏ Í∑∏Î†àÏù¥' },
    { type: 'color', value: '#1e293b', name: 'Îã§ÌÅ¨ Í∑∏Î†àÏù¥' },
    { type: 'color', value: '#ffffff', name: 'ÌôîÏù¥Ìä∏' },
    { type: 'color', value: '#000000', name: 'Î∏îÎûô' },
    { type: 'color', value: '#1e3a8a', name: 'Îã§ÌÅ¨ Î∏îÎ£®' },
    { type: 'color', value: '#7c2d12', name: 'Îã§ÌÅ¨ Ïò§Î†åÏßÄ' },
    { type: 'color', value: '#14532d', name: 'Îã§ÌÅ¨ Í∑∏Î¶∞' },
    { type: 'color', value: '#581c87', name: 'Îã§ÌÅ¨ ÌçºÌîå' }
  ]

  // DnD ÏÑºÏÑú ÏÑ§Ï†ï
  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8,
      },
    })
  )

  // Î™®Îã¨ Ìï∏Îì§Îü¨ Ìï®ÏàòÎì§
  const handleShowLoginModal = () => {
    setIsLoginModalOpen(true)
  }

  const handleLoginFromModal = () => {
    setIsLoginModalOpen(false)
    window.location.href = '/'
  }

  const handleSignUpFromModal = () => {
    setIsLoginModalOpen(false)
    window.location.href = '/signup'
  }

  const handleLogout = async () => {
    if (isGuestMode) {
      await exitGuestMode()
    } else {
      await logout()
    }
    router.push('/')
  }

  const handleUserNameUpdate = (newName: string) => {
    setUserName(newName)
  }

  // ÏúÑÏ†Ø Í¥ÄÎ†® Ìï®ÏàòÎì§
  const toggleEditMode = () => setIsEditMode(!isEditMode)
  const toggleSidebar = () => setIsSidebarOpen(!isSidebarOpen)

  const openAddWidgetModal = (type: string) => {
    setSelectedWidgetType(type)
    setNewWidgetData({})
    setFaviconLoading(false)
    setFaviconError(null)
    setIsAddWidgetModalOpen(true)
  }

  // ÏúÑÏ†Ø Ï∂îÍ∞Ä
  const addWidget = async () => {
    if (!dashboard) return

    let settings: IWidgetSettings

    switch (selectedWidgetType) {
      case 'link':
        const normalizedUrl = normalizeUrl(newWidgetData.url || 'https://example.com')
        const displayDomain = extractDomain(newWidgetData.url || 'https://example.com')
        const recommendedIcon = getRecommendedIcon(newWidgetData.url || 'https://example.com')
        
        const finalIcon = newWidgetData.faviconUrl || newWidgetData.icon || recommendedIcon
        
        settings = {
          url: normalizedUrl,
          title: newWidgetData.title || displayDomain || 'ÏÉà ÎßÅÌÅ¨',
          icon: finalIcon,
          description: newWidgetData.description || ''
        } as ILinkSettings
        break
      
      case 'checklist':
        settings = {
          title: newWidgetData.title || 'ÏÉà Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏',
          items: newWidgetData.items || [
            { id: '1', text: 'ÏÉà Ìï† Ïùº', completed: false }
          ]
        } as IChecklistSettings
        break
        
      case 'weather':
        settings = {
          city: newWidgetData.city || 'Seoul',
          country: newWidgetData.country || 'KR',
          unit: newWidgetData.unit || 'metric',
          showForecast: newWidgetData.showForecast || false
        } as IWeatherSettings
        break
        
      case 'memo':
        settings = {
          title: newWidgetData.title || 'ÏÉà Î©îÎ™®',
          content: newWidgetData.content || '',
          color: newWidgetData.color || '#f3f4f6'
        } as IMemoSettings
        break
        
      case 'search':
        settings = {
          engines: [
            { id: 'google', name: 'Google', url: 'https://www.google.com/search?q=', icon: 'üîç' },
            { id: 'naver', name: 'Naver', url: 'https://search.naver.com/search.naver?query=', icon: 'N' }
          ],
          defaultEngine: 'google',
          placeholder: 'Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî...'
        } as ISearchSettings
        break
        
      case 'calendar':
        settings = {
          view: 'month',
          startDayOfWeek: 0,
          showWeekNumbers: false,
          showTodayButton: true
        } as ICalendarSettings
        break
        
      default:
        settings = {} as IWidgetSettings
    }

    // ÌôîÎ©¥ ÌÅ¨Í∏∞Ïóê Îî∞Î•∏ ÏµúÎåÄ Ïó¥ Ïàò Í≥ÑÏÇ∞
    const getMaxCols = () => {
      if (typeof window === 'undefined') return 6
      const width = window.innerWidth
      if (width < 640) return 1
      if (width < 768) return 2
      if (width < 1024) return 3
      if (width < 1280) return 4
      return 6
    }

    const getMaxRows = () => {
      if (typeof window === 'undefined') return 4
      const availableHeight = window.innerHeight - 64 - 48
      const estimatedRowHeight = 200
      return Math.floor(availableHeight / estimatedRowHeight)
    }

    const maxCols = getMaxCols()
    const maxRows = getMaxRows()
    const maxWidgets = maxCols * maxRows

    if (widgets.length >= maxWidgets) {
      toast({
        variant: 'destructive',
        title: 'ÏïåÎ¶º',
        description: `ÌòÑÏû¨ ÌôîÎ©¥ÏóêÎäî ÏµúÎåÄ ${maxWidgets}Í∞úÏùò ÏúÑÏ†ØÎßå Î∞∞ÏπòÌï† Ïàò ÏûàÏäµÎãàÎã§.`
      })
      return
    }

    // Îπà ÏúÑÏπò Ï∞æÍ∏∞
    const findAvailablePosition = () => {
      for (let row = 0; row < maxRows; row++) {
        for (let col = 0; col < maxCols; col++) {
          const isOccupied = widgets.some(w => w.position_x === col && w.position_y === row)
          if (!isOccupied) {
            return { x: col, y: row }
          }
        }
      }
      return { x: 0, y: 0 }
    }

    const position = findAvailablePosition()

    const widgetData = {
      dashboard_id: dashboard.id,
      type: selectedWidgetType,
      position_x: position.x,
      position_y: position.y,
      width: selectedWidgetType === 'clock' ? 2 : 
             selectedWidgetType === 'search' ? 4 :
             selectedWidgetType === 'weather' ? 2 : 
             selectedWidgetType === 'calendar' ? 2 : 2,
      height: selectedWidgetType === 'checklist' ? 2 :
              selectedWidgetType === 'memo' ? 2 :
              selectedWidgetType === 'calendar' ? 3 : 1,
      settings
    }

    try {
      if (isGuestMode) {
        const widgetId = guestStorage.addWidget({
          type: selectedWidgetType,
          position_x: widgetData.position_x,
          position_y: widgetData.position_y,
          width: widgetData.width,
          height: widgetData.height,
          settings
        })
        
        const newWidget: IWidget = {
          id: widgetId,
          dashboard_id: 'guest-dashboard',
          type: selectedWidgetType as 'link' | 'checklist' | 'clock' | 'weather' | 'calendar' | 'search' | 'memo',
          position_x: widgetData.position_x,
          position_y: widgetData.position_y,
          width: widgetData.width,
          height: widgetData.height,
          settings,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        }
        
        setWidgets([...widgets, newWidget])
        setIsAddWidgetModalOpen(false)
        toast({
          title: 'ÏÑ±Í≥µ',
          description: 'ÏúÑÏ†ØÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.'
        })
      } else {
        const response = await fetch('/api/widgets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(widgetData)
        })
        
        const result = await response.json()
        
        if (result.success) {
          setWidgets([...widgets, result.data])
          setIsAddWidgetModalOpen(false)
          toast({
            title: 'ÏÑ±Í≥µ',
            description: 'ÏúÑÏ†ØÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.'
          })
        } else {
          toast({
            variant: 'destructive',
            title: 'Ïò§Î•ò',
            description: result.error || 'ÏúÑÏ†Ø Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.'
          })
        }
      }
    } catch (error) {
      toast({
        variant: 'destructive',
        title: 'Ïò§Î•ò',
        description: 'ÏúÑÏ†Ø Ï∂îÍ∞Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'
      })
    }
  }

  // Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ìï∏Îì§Îü¨
  const handleImageUpload = async (imageUrl: string) => {
    const background: IBackgroundOption = {
      type: 'image',
      value: `url(${imageUrl})`,
      name: 'ÏóÖÎ°úÎìúÎêú Ïù¥ÎØ∏ÏßÄ'
    }
    await updateDashboardBackground(background)
  }

  const handleImageRemove = async () => {
    const background: IBackgroundOption = {
      type: 'gradient',
      value: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
      name: 'Í∏∞Î≥∏ Í∑∏ÎùºÎç∞Ïù¥ÏÖò'
    }
    await updateDashboardBackground(background)
  }

  // DnD Ìï∏Îì§Îü¨
  const handleDragStart = (event: DragStartEvent) => {
    setActiveId(event.active.id as string)
  }

  const handleDragEnd = (event: DragEndEvent) => {
    setActiveId(null)
    
    const { active, over } = event
    
    if (over && active.id !== over.id) {
      const activeWidget = widgets.find(w => w.id === active.id)
      const overWidget = widgets.find(w => w.id === over.id)
      
      if (activeWidget && overWidget) {
        const updatedWidgets = widgets.map(widget => {
          if (widget.id === active.id) {
            return {
              ...widget,
              position_x: overWidget.position_x,
              position_y: overWidget.position_y
            }
          }
          if (widget.id === over.id) {
            return {
              ...widget,
              position_x: activeWidget.position_x,
              position_y: activeWidget.position_y
            }
          }
          return widget
        })
        
        setWidgets(updatedWidgets)
        saveWidgetPositions(updatedWidgets)
      }
    }
  }

  // Ïù∏Ï¶ù ÏÉÅÌÉú ÌôïÏù∏
  useEffect(() => {
    if (!isLoading && !isAuthenticated && !hasRedirectedRef.current) {
      hasRedirectedRef.current = true
      router.replace('/')
    }
  }, [isAuthenticated, isLoading, router])

  // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú
  useEffect(() => {
    if (isGuestMode) {
      const guestUsername = localStorage.getItem('guest_username')
      setUserName(guestUsername || 'Í≤åÏä§Ìä∏')
    } else if ((user as any)?.profile?.full_name) {
      setUserName((user as any).profile.full_name)
    } else if (user?.user_metadata?.full_name) {
      setUserName(user.user_metadata.full_name)
    } else if (user?.email) {
      setUserName(user.email.split('@')[0])
    }
  }, [user, isGuestMode])

  // ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  useEffect(() => {
    if (isAuthenticated) {
      loadDashboard()
    }
  }, [isAuthenticated, loadDashboard])

  // ÏãúÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(new Date())
    }, 1000)

    return () => clearInterval(timer)
  }, [])

  // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) {
        return
      }
      
      switch (e.key.toLowerCase()) {
        case 'e':
          e.preventDefault()
          setIsEditMode(!isEditMode)
          break
        case 'escape':
          e.preventDefault()
          setIsEditMode(false)
          setIsSidebarOpen(false)
          setIsAddWidgetModalOpen(false)
          setIsSettingsModalOpen(false)
          break
        case 'tab':
          e.preventDefault()
          setIsSidebarOpen(!isSidebarOpen)
          break
      }
    }

    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [isEditMode, isSidebarOpen])

  // Ïù∏Ï¶ùÎêòÏßÄ ÏïäÏùÄ ÏÇ¨Ïö©ÏûêÎäî Î†åÎçîÎßÅÌïòÏßÄ ÏïäÏùå
  if (!isAuthenticated || isDashboardLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full"></div>
      </div>
    )
  }

  const backgroundStyle = dashboard ? {
    background: dashboard.background_value
  } : {
    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
  }

  return (
    <div className="h-screen overflow-hidden" style={backgroundStyle}>
      {/* ÏÉÅÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */}
      <Navbar className="glass-effect border-b border-white/20 dark:border-gray-800/40">
        <div className="flex items-center justify-between w-full px-4">
          <div className="flex items-center space-x-2 sm:space-x-4">
            <Button
              variant="ghost"
              size="sm"
              onClick={toggleSidebar}
              className="macos-button-secondary hover:scale-105 transition-transform"
            >
              <Grid className="w-5 h-5" />
            </Button>
            <h1 className="text-lg sm:text-xl font-bold text-gray-900 dark:text-white tracking-tight">PersonalDash</h1>
          </div>
          
          <div className="flex items-center space-x-1 sm:space-x-3">
            {user && (
              <UserNameEditor 
                currentName={userName}
                onNameUpdate={handleUserNameUpdate}
                isGuestMode={isGuestMode}
              />
            )}
            <Badge variant={isEditMode ? "default" : "secondary"} className="hidden sm:inline-flex">
              {isEditMode ? 'Ìé∏Ïßë Î™®Îìú' : 'Î≥¥Í∏∞ Î™®Îìú'}
            </Badge>
            <Button
              variant={isEditMode ? "default" : "outline"}
              size="sm"
              onClick={toggleEditMode}
              className={`${isEditMode ? 'macos-button animate-macos-pulse' : 'macos-button-secondary'} hover:scale-105 transition-all`}
            >
              {isEditMode ? (
                <>
                  <Save className="w-4 h-4 sm:mr-2" />
                  <span className="hidden sm:inline">ÏôÑÎ£å</span>
                </>
              ) : (
                <>
                  <Edit className="w-4 h-4 sm:mr-2" />
                  <span className="hidden sm:inline">Ìé∏Ïßë</span>
                </>
              )}
            </Button>
            <div className="hidden sm:block">
              <ThemeToggle />
            </div>
            <Button 
              variant="ghost" 
              size="sm"
              onClick={() => setIsSettingsModalOpen(true)}
              className="macos-button-secondary hover:scale-105 transition-transform"
            >
              <Settings className="w-5 h-5" />
            </Button>
            <Button
              variant="outline"
              size="sm"
              onClick={handleLogout}
              className="macos-button-secondary text-red-500 hover:text-red-600 hover:scale-105 transition-all border-red-200 dark:border-red-800"
            >
              <LogOut className="w-4 h-4 sm:mr-2" />
              <span className="hidden sm:inline">Î°úÍ∑∏ÏïÑÏõÉ</span>
            </Button>
          </div>
        </div>
      </Navbar>

      <div className="flex h-[calc(100vh-4rem)]">
        {/* ÏÇ¨Ïù¥ÎìúÎ∞î */}
        <Sidebar
          isSidebarOpen={isSidebarOpen}
          onOpenAddWidgetModal={openAddWidgetModal}
          onOpenSettingsModal={() => setIsSettingsModalOpen(true)}
          onLayoutReset={handleLayoutReset}
        />

        {/* Î©îÏù∏ ÏΩòÌÖêÏ∏† */}
        <div className={`flex-1 transition-all duration-300 overflow-hidden ${
          isSidebarOpen ? 'lg:ml-80 md:ml-72 sm:ml-64 ml-0' : 'ml-0'
        }`}>
          <div className="h-full p-4 sm:p-6 overflow-auto">
            <div className="max-w-7xl mx-auto">
              {/* ÏúÑÏ†Ø Í∑∏Î¶¨Îìú */}
              <DndContext
                sensors={sensors}
                collisionDetection={closestCenter}
                onDragStart={handleDragStart}
                onDragEnd={handleDragEnd}
              >
                <SortableContext items={widgets?.map(w => w.id) || []} strategy={rectSortingStrategy}>
                  <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4 auto-rows-fr min-h-[calc(100vh-8rem)]">
                    {widgets
                      ?.sort((a, b) => {
                        if (a.position_y !== b.position_y) {
                          return a.position_y - b.position_y
                        }
                        return a.position_x - b.position_x
                      })
                      ?.map((widget) => (
                        <SortableWidget
                          key={widget.id}
                          id={widget.id}
                          widget={widget}
                          isEditMode={isEditMode}
                        >
                          <ResizableWidget
                            id={widget.id}
                            widget={widget}
                            isEditMode={isEditMode}
                            onResize={handleWidgetResize}
                          >
                            <WidgetRenderer
                              widget={widget}
                              isEditMode={isEditMode}
                              onRemove={removeWidget}
                              onSettingsChange={updateWidgetSettings}
                              onChecklistItemChange={updateChecklistItem}
                              currentTime={currentTime}
                            />
                          </ResizableWidget>
                        </SortableWidget>
                      )) || []}
                  </div>
                </SortableContext>
                
                <DragOverlay>
                  {activeId ? (
                    <div className="opacity-0">
                      <WidgetRenderer
                        widget={widgets.find(w => w.id === activeId)!}
                        isEditMode={isEditMode}
                        onRemove={removeWidget}
                        currentTime={currentTime}
                      />
                    </div>
                  ) : null}
                </DragOverlay>
              </DndContext>

              {/* Îπà ÏÉÅÌÉú */}
              {widgets.length === 0 && (
                <div className="text-center py-12 min-h-[calc(100vh-8rem)] flex flex-col justify-center">
                  <Grid className="w-16 h-16 mx-auto text-white/50 mb-4" />
                  <h3 className="text-lg font-medium text-white/80 mb-2">
                    ÏúÑÏ†ØÏùÑ Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî
                  </h3>
                  <p className="text-white/60 mb-6">
                    ÏôºÏ™Ω ÏÇ¨Ïù¥ÎìúÎ∞îÏóêÏÑú ÏõêÌïòÎäî ÏúÑÏ†ØÏùÑ ÏÑ†ÌÉùÌïòÏó¨ ÎåÄÏãúÎ≥¥ÎìúÎ•º Íµ¨ÏÑ±ÌïòÏÑ∏Ïöî
                  </p>
                  <Button onClick={toggleSidebar} className="bg-white/20 hover:bg-white/30 text-white border-white/30">
                    <Plus className="w-4 h-4 mr-2" />
                    ÏúÑÏ†Ø Ï∂îÍ∞ÄÌïòÍ∏∞
                  </Button>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Î™®Îã¨Îì§ */}
      <AddWidgetModal
        isOpen={isAddWidgetModalOpen}
        onClose={() => setIsAddWidgetModalOpen(false)}
        selectedWidgetType={selectedWidgetType}
        newWidgetData={newWidgetData}
        setNewWidgetData={setNewWidgetData}
        onAddWidget={addWidget}
        faviconLoading={faviconLoading}
        setFaviconLoading={setFaviconLoading}
        faviconError={faviconError}
        setFaviconError={setFaviconError}
      />
      
      <SettingsModal
        isOpen={isSettingsModalOpen}
        onClose={() => setIsSettingsModalOpen(false)}
        dashboard={dashboard}
        backgroundOptions={backgroundOptions}
        onUpdateBackground={updateDashboardBackground}
        onImageUpload={handleImageUpload}
        onImageRemove={handleImageRemove}
        isGuestMode={isGuestMode}
        onShowLoginModal={handleShowLoginModal}
        onImportSuccess={() => {
          loadDashboard()
          setIsSettingsModalOpen(false)
        }}
      />
      
      {/* Î°úÍ∑∏Ïù∏ Î™®Îã¨ */}
      <LoginModal
        isOpen={isLoginModalOpen}
        onClose={() => setIsLoginModalOpen(false)}
        onLogin={handleLoginFromModal}
        onSignUp={handleSignUpFromModal}
        title="Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§"
        message="Ïù¥ Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§."
      />

      {/* ÏÇ¨Ïù¥ÎìúÎ∞î Ïò§Î≤ÑÎ†àÏù¥ (Î™®Î∞îÏùº) */}
      {isSidebarOpen && (
        <div 
          className="fixed inset-0 bg-black bg-opacity-50 z-5 lg:hidden"
          onClick={toggleSidebar}
        />
      )}

      {/* Îã®Ï∂ïÌÇ§ ÌûåÌä∏ */}
      <div className="fixed bottom-4 right-4 bg-black/70 text-white px-3 py-2 rounded-lg text-sm">
        E: Ìé∏Ïßë | Tab: ÏÇ¨Ïù¥ÎìúÎ∞î | Esc: Ï¢ÖÎ£å
      </div>
    </div>
  )
}